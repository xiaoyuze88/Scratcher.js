!function(a){if("object"==typeof exports&&"object"==typeof module)module.exports=a();else{if("function"==typeof define&&define.amd)return define([],a);this.Scratcher=a()}}(function(){"use strict";function e(a){if(!a)throw new Error("Options is empty!");if(!f.call(this,a))throw new Error("Options is not legal!");g.call(this)}function f(a){var e,b={selector:null,imgUrl:a.imgUrl,width:null,height:null,weight:80,startRightNow:!1,noRetina:!1,leftCountAccuracy:64,useDebouncing:!0,debouncingTimeGap:500,useFakeCaculate:!1},c=this;for(e in b)b.hasOwnProperty(e)&&(this[e]=e in a?a[e]:b[e]);return this.selector?(this.canvas=$(this.selector)[0],this.ctx=this.canvas.getContext("2d"),this.ctx?(this.fresh=!0,this.isStart=this.startRightNow?!0:!1,this.scratchOver=!1,this._eventsList={},$.each(d.split(" "),function(){c._eventsList[this]=[]}),a.onScratch&&k(a.onScratch)&&this.on("scratch",a.onScratch),a.onLoadFinish&&k(a.onLoadFinish)&&this.on("loadFinish",a.onLoadFinish),a.onScratchFinish&&k(a.onScratchFinish)&&this.on("scratchFinish",a.onScratchFinish),this.handleStart=i.bind(this),this.handleMove=j.bind(this),this.width||(this.width=parseFloat(getComputedStyle(this.canvas).getPropertyValue("width").replace("px",""))),this.height||(this.height=parseFloat(getComputedStyle(this.canvas).getPropertyValue("height").replace("px",""))),this.forRetinaRate=this.noRetina?1:2,this.position=$(this.canvas).offset(),this.debouncing=!1,this.useFakeCaculate&&(this.fakeTimer=null,this.fakeCounter=0),!0):!1):!1}function g(){function c(){this.trigger("loadFinish"),this.canvas.width=this.width*this.forRetinaRate,this.canvas.height=this.height*this.forRetinaRate,this.ctx.drawImage(b,0,0,this.canvas.width,this.canvas.height),this.ctx.lineCap=this.ctx.lineJoin="round",this.ctx.lineWidth=this.weight*this.forRetinaRate,this.ctx.globalCompositeOperation="destination-out",h.call(this)}var b=new Image;$(b).on("load",c.bind(this)),b.src=this.imgUrl}function h(){this.isStart&&$(document).on(b.DOWN,this.handleStart)}function i(a){var d,e,f,g,h,c=this;this.fakeTimer&&clearTimeout(this.fakeTimer),"mousedown"==a.type&&(a=l(a)),d=a.touches[0],e=d["pageX"],f=d["pageY"],g=e-this.position.left,h=f-this.position.top,this.x1=g*this.forRetinaRate,this.y1=h*this.forRetinaRate,this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(this.x1,this.y1,this.weight,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill(),this.ctx.restore(),$(document).on(b.MOVE,this.handleMove),$(document).one(b.UP,function(){$(document).off(b.MOVE,this.handleMove),c.useFakeCaculate&&(this.fakeTimer=setTimeout(function(){c.fakeCounter>120&&(c.trigger("scratchFinish"),c.clear(),c.scratchOver=!0)}))})}function j(a){var d,e,f,g,h,i;this.isStart&&!this.scratchOver?(this.trigger("scratch"),this.useFakeCaculate&&(this.fakeCounter++,this.fakeTimer&&clearTimeout(this.fakeTimer)),"mousemove"==a.type&&(a=l(a)),d=a.touches[0],e=d["pageX"],f=d["pageY"],g=e-this.position.left,h=f-this.position.top,this.x2=2*g,this.y2=2*h,this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(this.x1,this.y1),this.ctx.lineTo(this.x2,this.y2),this.ctx.closePath(),c.hasIssueCanvas&&(i=0|1e7*Math.random(),this.canvas.style.color="#"+i.toString(16)),this.ctx.stroke(),this.ctx.restore(),!this.useFakeCaculate&&this._eventsList.scratchFinish.length>0&&this.checkLeft(),this.x1=this.x2,this.y1=this.y2):$(document).off(b.MOVE,this.handleMove)}function k(a){return"function"==typeof a}function l(a){return a.touches=[{pageX:a.pageX,pageY:a.pageY}],a}var a="ontouchstart"in window,b={DOWN:a?"touchstart":"mousedown",UP:a?"touchend":"mouseup",MOVE:a?"touchmove":"mousemove"},c=function(){var d,a=navigator.userAgent.toLowerCase(),b=a.indexOf("android")>-1?!0:!1,c=-1;return b&&(c=a.split("android")[1],c=parseFloat(c.substring(0,c.indexOf(";")))),d=b&&4.2==c,{hasIssueCanvas:d}}(),d="scratch loadFinish scratchFinish";return e.prototype.checkLeft=function(){var a,b,c,d,e,f,g,h,i;if(!this.useDebouncing||!this.debouncing){for(g=this,h=4*this.leftCountAccuracy,this.debouncing=!0,e=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),f=e.data,b=f.length,d=0|b/h,a=c=0;b>a;a+=h)0!=f[a]&&c++;i=0|100*(c/d),3>i&&(this.trigger("scratchFinish"),this.scratchOver=!0,g.clear()),this.useDebouncing&&setTimeout(function(){g.debouncing=!1},500)}},e.prototype.resize=function(){this.width=parseFloat(getComputedStyle(this.canvas).getPropertyValue("width").replace("px","")),this.height=parseFloat(getComputedStyle(this.canvas).getPropertyValue("height").replace("px","")),this.position=$(this.canvas).offset()},e.prototype.start=function(){this.isStart=!0,$(document).on(b.DOWN,this.handleStart)},e.prototype.clear=function(){this.ctx.clearRect(0,0,this.width*this.forRetinaRate,this.height*this.forRetinaRate)},e.prototype.on=function(a,b){-1!=d.indexOf(a)&&(this._eventsList.hasOwnProperty(a)||(this._eventsList[a]=[]),this._eventsList[a].push(b))},e.prototype.off=function(a,b){if(this._eventsList.hasOwnProperty(a)){var c;b?(c=this._eventsList[type].indexOf(b))>-1&&this._eventsList[type].splice(c,1):this._eventsList[type]=[]}},e.prototype.trigger=function(a){var b=this;-1!=d.indexOf(a)&&this._eventsList.hasOwnProperty(a)&&$.each(this._eventsList[a],function(){k(this)&&this.call(b)})},Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d?this:a||window,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),e});